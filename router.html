<!DOCTYPE html>
<html lang="en">
<head>
    <title>Geolocation</title>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.8.0/dist/leaflet.css" />
    <link rel="stylesheet" href="https://unpkg.com/leaflet-routing-machine@latest/dist/leaflet-routing-machine.css" />
    <style>
        body {
            margin: 0;
            padding: 0;
        }
    </style>
    <link rel="stylesheet" href="menu.css">

</head>

<body>
<div id="map" style="width:100%; height: 100vh"></div>

<div class="menu">
    <div class="navigation">
        <ul>
            <li class="list">
                <a href="index.html">
                    <span class="icon"><ion-icon name="planet-outline"></ion-icon></span>
                    <span class="text">home</span>
                </a>
            </li>
            <li class="list">
                <a href="map.html">
                    <span class="icon"><ion-icon name="map-outline"></ion-icon></span>
                    <span class="text">map</span>
                </a>
            </li>
            <li class="list active">
                <a href="router.html">
                    <span class="icon"><ion-icon name="navigate-circle-outline"></ion-icon></span>
                    <span class="text">router</span>
                </a>
            </li>
            <li class="list">
                <a href="meter.html">
                    <span class="icon"><ion-icon name="speedometer-outline"></ion-icon></span>
                    <span class="text">meter</span>
                </a>
            </li>
            <li class="list">
                <a href="#">
                    <span class="icon"><ion-icon name="document-text-outline"></ion-icon></span>
                    <span class="text">note</span>
                </a>
            </li>
            <li class="list">
                <a href="#">
                    <span class="icon"><ion-icon name="document-text-outline"></ion-icon></span>
                    <span class="text">photo</span>
                </a>
            </li>
            <li class="list">
                <a href="#">
                    <span class="icon"><ion-icon name="videocam-outline"></ion-icon></span>
                    <span class="text">photo</span>
                </a>
            </li>

        </ul>
    </div>
</div>
<script src="https://unpkg.com/leaflet@1.8.0/dist/leaflet.js"></script>
<script src="https://unpkg.com/leaflet-routing-machine@latest/dist/leaflet-routing-machine.js"></script>
<script src="config.js"></script>
<script>
    if(!navigator.geolocation){

    }else {
        navigator.geolocation.getCurrentPosition(function (position){
            config.map.lat = position.coords.latitude;
            config.map.long = position.coords.longitude;
        });
    }


    setTimeout(function (){



        var map = L.map('map').setView([config.map.lat, config.map.long], config.map.zoom);
        var osm = L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
            maxZoom: config.map.maxZoom,
            attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors'
        });
        osm.addTo(map);

        // dark map
        var dark = L.tileLayer('https://{s}.basemaps.cartocdn.com/dark_all/{z}/{x}/{y}{r}.png', {
            attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors &copy; <a href="https://carto.com/attributions">CARTO</a>',
            subdomains: 'abcd',
            maxZoom: config.map.maxZoom,
        });
        // dark.addTo(map)

        // google street
        googleStreets = L.tileLayer('http://{s}.google.com/vt/lyrs=m&x={x}&y={y}&z={z}', {
            maxZoom: config.map.maxZoom,
            subdomains: ['mt0', 'mt1', 'mt2', 'mt3']
        });
        // googleStreets.addTo(map);

        //google satellite
        googleSat = L.tileLayer('http://{s}.google.com/vt/lyrs=s&x={x}&y={y}&z={z}', {
            maxZoom: config.map.maxZoom,
            
            subdomains: ['mt0', 'mt1', 'mt2', 'mt3']
        });
        // googleSat.addTo(map)


        var taxiIcon = L.icon({
            iconUrl: config.map.maker,
            iconSize: [70, 70]
        })

        var marker = L.marker([config.map.lat,config.map.long], { icon: taxiIcon }).addTo(map);


        /*==============================================
                        LAYER CONTROL
        ================================================*/
        var baseMaps = {
            "OSM": osm,
            'Dark': dark,
            'Google Street': googleStreets,
            "Google Satellite": googleSat,
        };

        // map.removeLayer(singleMarker)


        var overlayMaps = {}
        L.control.layers(baseMaps, overlayMaps, {collapsed: true}).addTo(map);


        function setMap(position){

            config.map.lat = position.coords.latitude
            config.map.long = position.coords.longitude
            config.map.accuracy = position.coords.accuracy


            if (marker) {
                map.removeLayer(marker)
            }

            marker = L.marker([config.map.lat, config.map.long], { icon: taxiIcon }).addTo(map)
        }


        map.on('click', function (e) {

          /*  if (marker) {
                map.removeLayer(marker)
            }*/

            L.marker([e.latlng.lat, e.latlng.lng]).addTo(map);
            L.Routing.control({
                waypoints: [
                    L.latLng(config.map.lat, config.map.long),
                    L.latLng(e.latlng.lat, e.latlng.lng)
                ]
            }).on('routesfound', function (e) {
                var routes = e.routes;
                console.log(routes);

                e.routes[0].coordinates.forEach(function (coord, index) {
                    setTimeout(function () {
                        marker.setLatLng([coord.lat, coord.lng]);
                    }, 100 * index)
                })

            }).addTo(map);
        });



        //watch

        let id;
        let target;
        let options;

        function success(pos) {
            const crd = pos.coords;

            if (target.latitude === crd.latitude && target.longitude === crd.longitude) {
                navigator.geolocation.clearWatch(id);
            } else {
                setMap(pos);
                map.setZoom(config.map.zoom)
            }

        }

        function error(err) {

            mylog(`ERROR(${err.code}): ${err.message}`)
            //console.error();
        }

        target = {
            latitude: 0,
            longitude: 0
        };

        options = {
            zoom: config.map.zoom,
            desiredAccuracy: 1,
            frequency: config.map.timereset,
            enableHighAccuracy: false,
            timeout: config.map.timeout,
            maximumAge: 0
        };

        id = navigator.geolocation.watchPosition(success, error, options);


        //clearTimeout();

    }, 1000);


</script>

<script type="module" src="https://unpkg.com/ionicons@5.5.2/dist/ionicons/ionicons.esm.js"></script>
<script nomodule src="https://unpkg.com/ionicons@5.5.2/dist/ionicons/ionicons.js"></script>
</body>

</html>